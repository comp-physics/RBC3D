name: 'Test on Phoenix'

on:
    pull_request:
    workflow_dispatch:

jobs:
  self:
    name: Phoenix Runner
    runs-on:
        labels: gt
    if: github.repository == 'Comp-Physics/RBC3D'
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Build Packages
        run: |
            ml gcc/12.1.0-qgxpzk mvapich2/2.3.7-733lcv python/3.9.12-rkxvr6
            ./rbc.sh install-lapack

      # will stop on any errors
      - name: Compile Cases
        run: |
            ml gcc mvapich2 python/3.9.12-rkxvr6 netcdf-fortran fftw cmake
            set -e -x
            export PETSC_DIR=`pwd`/packages/petsc-3.19.6
            export PETSC_ARCH=arch-linux-c-opt
            mkdir build
            cd build
            cmake ..
            make
            echo "/common and all cases in /examples compiled successfully!"
      
      - name: Make Case
        run: |
            ml gcc mvapich2 python/3.9.12-rkxvr6 netcdf-fortran fftw cmake
            set -e -x
            export PETSC_DIR=`pwd`/packages/petsc-3.19.6
            export PETSC_ARCH=arch-linux-c-opt
            ./rbc.sh install-makedepf90
            cd common
            make .depend
            make
            cd ../examples/case
            make .depend
            make
            echo "/common and all cases in /examples compiled successfully!"
