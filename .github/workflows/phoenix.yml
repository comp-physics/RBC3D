name: 'Test on Phoenix'

on:
    pull_request:
    workflow_dispatch:

jobs:
  self:
    name: Phoenix Runner
    runs-on:
        labels: gt
    if: github.repository == 'Comp-Physics/RBC3D'
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      # use mkl option
      - name: Build Packages
        run: |
            ml gcc mvapich2 mkl python/3.9.12-rkxvr6
            directory_to_remove=/usr/mpi/gcc/openmpi-4.1.2a1/bin
            PATH=:$PATH:
            PATH=${PATH//:$directory_to_remove:/:}
            PATH=${PATH#:}; PATH=${PATH%:}
            ./rbc.sh install

      # will stop on any errors
      - name: Compile Cases
        run: |
            ml gcc mvapich2 mkl python/3.9.12-rkxvr6 netcdf-fortran fftw cmake
            set -e -x
            export PETSC_DIR=`pwd`/packages/petsc-3.19.6
            export PETSC_ARCH=arch-linux-c-opt
            mkdir build
            cd build
            cmake ..
            make
            echo "/common and all cases in /examples compiled successfully!"
